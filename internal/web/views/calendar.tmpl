{{define "content"}}
<div style="display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px;">
  <div style="display:flex; align-items:center; gap:8px;">
    <h1 style="margin:0;">Calendar</h1>
    <a class="btn" href="{{.TodayURL}}" aria-label="Jump to today">Today</a>
  </div>
  <div style="display:flex; align-items:center; gap:8px;">
    <div class="mode-toggle">
      <a class="mode-option {{if eq .View "month"}}active{{end}}" href="{{.MonthLink}}">Month</a>
      <a class="mode-option {{if eq .View "week"}}active{{end}}" href="{{.WeekLink}}">Week</a>
    </div>
    <a class="btn" href="{{.PrevURL}}" aria-label="Previous period">&#8592;</a>
    <div style="font-weight:600; min-width:180px; text-align:center;">
      {{if eq .View "week"}}{{.WeekLabel}}{{else}}{{.MonthLabel}}{{end}}
    </div>
    <a class="btn" href="{{.NextURL}}" aria-label="Next period">&#8594;</a>
  </div>
</div>

{{if eq .View "week"}}
  <div class="card">
    <div class="card-head">Week summary</div>
    <div class="metrics week-summary-metrics">
      <div class="metric"><div class="metric-value">{{printf "%.2f" (div .WeekTotals.DistM 1000)}} <span class="metric-unit">km</span></div><div class="metric-label">Distance</div></div>
      <div class="metric"><div class="metric-value">{{fmtDuration .WeekTotals.DurS}}</div><div class="metric-label">Time</div></div>
    <div class="metric"><div class="metric-value">{{.WeekTotals.Calories}} <span class="metric-unit">kcal</span></div><div class="metric-label">Calories</div></div>
    <div class="metric"><div class="metric-value">{{.WeekTotals.Count}}</div><div class="metric-label">Activities</div></div>
  </div>
</div>

<div class="card week-card">
  <div class="week-days">
    {{range .WeekDays}}
      <div class="week-day {{if .IsToday}}is-today{{end}}">
        <div class="week-day-header">
          <div class="week-date">{{.Date.Format "Mon 02"}}</div>
          <div class="week-day-meta">
            <span>{{printf "%.1f km" (div .Totals.DistM 1000)}}</span>
            <span>· {{fmtDuration .Totals.DurS}}</span>
            {{if gt .Totals.Calories 0}}<span>· {{.Totals.Calories}} kcal</span>{{end}}
          </div>
        </div>
          {{$day := .}}
          <div class="week-day-entries">
          {{range .Items}}
            <a class="calendar-entry {{sportClass .Sport}}" href="/activity/{{.ID}}">
              <span class="calendar-entry-title">{{.Sport}}</span>
              <span class="calendar-entry-meta">{{printf "%.1f km" .DistKm}} · {{fmtDuration .DurS}}</span>
              </a>
            {{end}}
            {{range .Planned}}
              <div class="calendar-entry planned-entry {{sportClass .Sport}}">
                <div class="calendar-entry-head">
                  <details class="plan-edit">
                    <summary class="calendar-entry-title" title="Edit planned workout">{{.Sport}}</summary>
                    <form method="POST" action="/calendar/plan/edit" class="plan-form plan-edit">
                      <input type="hidden" name="id" value="{{.ID}}">
                      <input type="hidden" name="date" value="{{$day.Date.Format "2006-01-02"}}">
                      <div class="plan-form-row single">
                        <label>Sport
                          <select name="sport" required>
                            <option value="{{.Sport}}">{{.Sport}}</option>
                            {{range $.Sports}}<option value="{{.}}">{{.}}</option>{{end}}
                          </select>
                        </label>
                      </div>
                      <div class="plan-form-row">
                        <label>Distance (km)<input name="distance_km" inputmode="decimal" pattern="[0-9]*[.]?[0-9]*" value="{{if gt .DistKm 0.0}}{{printf "%.1f" .DistKm}}{{end}}"></label>
                        <label>Duration (min)<input name="duration_min" inputmode="numeric" pattern="[0-9]*" value="{{if gt .DurS 0}}{{div .DurS 60}}{{end}}"></label>
                      </div>
                      <label>Notes<textarea name="notes" rows="2">{{.Notes}}</textarea></label>
                      <div class="plan-form-actions">
                        <button type="submit" class="btn">Save</button>
                      </div>
                    </form>
                  </details>
                  <form method="POST" action="/calendar/plan" style="margin:0;">
                    <input type="hidden" name="date" value="{{$day.Date.Format "2006-01-02"}}">
                    <input type="hidden" name="sport" value="{{.Sport}}">
                    <input type="hidden" name="distance_km" value="{{if gt .DistKm 0.0}}{{printf "%.1f" .DistKm}}{{end}}">
                    <input type="hidden" name="duration_min" value="{{if gt .DurS 0}}{{div .DurS 60}}{{end}}">
                    <input type="hidden" name="notes" value="{{.Notes}}">
                    <button class="plan-entry-duplicate" type="submit" title="Duplicate planned workout">⧉</button>
                  </form>
                  <form method="POST" action="/calendar/plan/delete" onsubmit="return confirm('Delete planned workout?');">
                    <input type="hidden" name="id" value="{{.ID}}">
                    <input type="hidden" name="date" value="{{$day.Date.Format "2006-01-02"}}">
                    <button class="plan-entry-delete" type="submit" title="Delete planned workout">×</button>
                  </form>
                </div>
                <span class="calendar-entry-meta">
                  {{if gt .DistKm 0.0}} {{printf "%.1f km" .DistKm}}{{end}}
                  {{if gt .DurS 0}} · {{fmtDuration .DurS}}{{end}}
                </span>
                <div class="plan-move">
                  <form method="POST" action="/calendar/plan/move" style="margin:0; padding:0;">
                    <input type="hidden" name="id" value="{{.ID}}">
                    <input type="hidden" name="date" value="{{$day.Date.Format "2006-01-02"}}">
                    <input type="hidden" name="delta" value="-1">
                    <button type="submit" class="plan-entry-move" title="Move to previous day">←</button>
                  </form>
                  <form method="POST" action="/calendar/plan/move" style="margin:0; padding:0;">
                    <input type="hidden" name="id" value="{{.ID}}">
                    <input type="hidden" name="date" value="{{$day.Date.Format "2006-01-02"}}">
                    <input type="hidden" name="delta" value="1">
                    <button type="submit" class="plan-entry-move" title="Move to next day">→</button>
                  </form>
                </div>
              </div>
            {{end}}
          </div>
          <details class="plan-details">
            <summary title="Plan workout for this day">+</summary>
            <form method="POST" action="/calendar/plan" class="plan-form plan-add">
              <input type="hidden" name="date" value="{{.Date.Format "2006-01-02"}}">
              <div class="plan-form-row single">
                <label>Sport
                  <select name="sport" required>
                    <option value="">Select</option>
                    {{range $.Sports}}<option value="{{.}}">{{.}}</option>{{end}}
                  </select>
                </label>
              </div>
              <div class="plan-form-row">
                <label>Distance (km)<input name="distance_km" inputmode="decimal" pattern="[0-9]*[.]?[0-9]*" placeholder="10"></label>
                <label>Duration (min)<input name="duration_min" inputmode="numeric" pattern="[0-9]*" placeholder="50"></label>
              </div>
              <label>Notes<textarea name="notes" rows="2" placeholder="Optional"></textarea></label>
              <div class="plan-form-actions">
                <button type="submit" class="btn">Save</button>
              </div>
            </form>
          </details>
        </div>
      {{end}}
    </div>
  </div>
{{else}}
<div class="card calendar-card">
  <div class="calendar-weekdays calendar-weekdays-month">
    <span>Mon</span><span>Tue</span><span>Wed</span><span>Thu</span><span>Fri</span><span>Sat</span><span>Sun</span>
    <span class="calendar-week-summary-head">Weekly totals</span>
  </div>
  <div class="calendar-grid calendar-grid-month">
    {{range $i, $week := .Grid}}
      {{range $week}}
        <div class="calendar-day {{if .IsToday}}is-today{{end}} {{if not .InMonth}}is-muted{{end}}">
          <div class="calendar-day-header">
            <span class="calendar-date">{{.Date.Day}}</span>
            <span class="calendar-weekday">{{.Date.Format "Mon"}}</span>
          </div>
          {{$day := .}}
          <div class="calendar-entries">
            {{if and (not .InMonth) (eq (len .Items) 0)}}
            {{else}}
              {{range .Items}}
                <a class="calendar-entry {{sportClass .Sport}}" href="/activity/{{.ID}}">
                  <span class="calendar-entry-title">{{.Sport}}</span>
                  <span class="calendar-entry-meta">{{printf "%.1f km" .DistKm}} · {{fmtDuration .DurS}}</span>
                </a>
              {{end}}
              {{range .Planned}}
                <div class="calendar-entry planned-entry {{sportClass .Sport}}">
                <div class="calendar-entry-head">
                    <span class="calendar-entry-title">{{.Sport}}</span>
                </div>
                  <span class="calendar-entry-meta">
                    {{if gt .DistKm 0.0}} {{printf "%.1f km" .DistKm}}{{end}}
                    {{if gt .DurS 0}} · {{fmtDuration .DurS}}{{end}}
                  </span>
                </div>
              {{end}}
            {{end}}
          </div>
        </div>
      {{end}}
      <div class="calendar-week-summary">
        {{with index $.WeekRowTotals $i}}
          <div class="calendar-week-summary-row"><span>Distance</span><b>{{printf "%.1f km" (div .DistM 1000)}}</b></div>
          <div class="calendar-week-summary-row"><span>Time</span><b>{{fmtDuration .DurS}}</b></div>
          <div class="calendar-week-summary-row"><span>Calories</span><b>{{.Calories}}</b></div>
          <div class="calendar-week-summary-row"><span>Activities</span><b>{{.Count}}</b></div>
        {{end}}
      </div>
    {{end}}
  </div>
</div>
{{end}}
{{end}}
