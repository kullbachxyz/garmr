{{define "content"}}
<h1>Statistics</h1>

<div class="stats-controls simple">
  <form method="GET" class="stats-filter stats-filter-inline">
    <label for="sport">Sport:</label>
    <select id="sport" name="sport" onchange="this.form.submit()">
      <option value="" {{if eq .CurrentSport ""}}selected{{end}}>All</option>
      {{range .Sports}}
        <option value="{{.}}" {{if eq $.CurrentSport .}}selected{{end}}>{{.}}</option>
      {{end}}
    </select>
    <div class="mode-toggle" id="mode-toggle">
      <button type="button" class="mode-option active" id="mode-month" data-tab="month">Month</button>
      <button type="button" class="mode-option" id="mode-year" data-tab="year">Year</button>
    </div>
    <div class="tab-controls" id="filter-year">
      <label for="select-year">Year:</label>
      <select id="select-year" name="year" onchange="this.form.submit()">
        <option value="{{.YearLabel}}" selected>{{.YearLabel}}</option>
      </select>
    </div>
    <div class="tab-controls" id="filter-month">
      <label for="select-month">Month:</label>
        <select id="select-month" name="month" onchange="this.form.submit()">
          <option value="{{.MonthInput}}" selected>{{.MonthLabel}}</option>
        </select>
    </div>
    <input type="hidden" id="tab" name="tab" value="{{.CurrentTab}}" />
    <input type="hidden" id="hidden-month" value="{{.MonthInput}}" />
    <input type="hidden" id="hidden-year" value="{{.YearInput}}" />
  </form>
</div>

  <!-- Charts -->
  <div id="chart-month" class="chart-wrap">
    <canvas id="chartMonthCanvas"></canvas>
  </div>
  <div id="chart-year" class="chart-wrap">
    <canvas id="chartYearCanvas"></canvas>
  </div>
</div>



<!-- ====== PERIOD STATS ====== -->
<section class="cards-grid" style="display:grid; grid-template-columns: 1fr; gap:16px; margin-bottom:20px;">

  <!-- MONTH -->
  <div class="card" id="stats-month">
    <div class="card-head">This month <span id="stats-month-label" style="color:#6b7280; font-weight:normal;">({{.MonthLabel}})</span></div>
    <div class="metrics">
      <div class="metric"><div class="metric-value" id="month-dist">{{printf "%.2f" (div .Month.DistM 1000)}} <span class="metric-unit">km</span></div><div class="metric-label">Distance</div></div>
      <div class="metric"><div class="metric-value" id="month-dur">{{fmtDuration .Month.DurS}}</div><div class="metric-label">Time</div></div>
      <div class="metric"><div class="metric-value" id="month-pace">{{fmtPace .Month.AvgSpd}}</div><div class="metric-label">Avg pace</div></div>
      <div class="metric"><div class="metric-value" id="month-elev">{{printf "%.0f" .Month.ElevM}} <span class="metric-unit">m</span></div><div class="metric-label">Ascent</div></div>
      <div class="metric"><div class="metric-value" id="month-count">{{.Month.Count}}</div><div class="metric-label">Activities</div></div>
    </div>
  </div>

  <!-- YEAR -->
  <div class="card" id="stats-year">
    <div class="card-head">This year <span id="stats-year-label" style="color:#6b7280; font-weight:normal;">({{.YearLabel}})</span></div>
    <div class="metrics">
      <div class="metric"><div class="metric-value" id="year-dist">{{printf "%.2f" (div .Year.DistM 1000)}} <span class="metric-unit">km</span></div><div class="metric-label">Distance</div></div>
      <div class="metric"><div class="metric-value" id="year-dur">{{fmtDuration .Year.DurS}}</div><div class="metric-label">Time</div></div>
      <div class="metric"><div class="metric-value" id="year-pace">{{fmtPace .Year.AvgSpd}}</div><div class="metric-label">Avg pace</div></div>
      <div class="metric"><div class="metric-value" id="year-elev">{{printf "%.0f" .Year.ElevM}} <span class="metric-unit">m</span></div><div class="metric-label">Ascent</div></div>
      <div class="metric"><div class="metric-value" id="year-count">{{.Year.Count}}</div><div class="metric-label">Activities</div></div>
    </div>
  </div>

</section>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const $ = (id) => document.getElementById(id);

  const wrapMonth = $('chart-month');
  const wrapYear  = $('chart-year');
  const selMonth  = $('select-month');
  const selYear   = $('select-year');
  const statsMonth = $('stats-month');
  const statsYear  = $('stats-year');
  const tabInput  = $('tab');
  const monthLabel = $('stats-month-label');
  const hiddenMonth = $('hidden-month');
  const hiddenYear = $('hidden-year');
  const yearLabel = $('stats-year-label');
  const monthDist = $('month-dist');
  const monthDur = $('month-dur');
  const monthPace = $('month-pace');
  const monthElev = $('month-elev');
  const monthCount = $('month-count');
  const yearDist = $('year-dist');
  const yearDur = $('year-dur');
  const yearPace = $('year-pace');
  const yearElev = $('year-elev');
  const yearCount = $('year-count');
  const filterMonth = $('filter-month');
  const filterYear = $('filter-year');
  const modeMonth = $('mode-month');
  const modeYear = $('mode-year');
  const filterForm = document.querySelector('.stats-filter');

  // Get current sport filter from URL
  const urlParams = new URLSearchParams(window.location.search);
  const currentSport = urlParams.get('sport') || '';
  const startMonth = urlParams.get('month') || (hiddenMonth?.value ?? '');
  const startYear = urlParams.get('year') || (hiddenYear?.value ?? '');

  let chartMonth = null, chartYear = null;

  function activate(tab){
    const monthActive = (tab === 'month');
    wrapMonth.style.display = monthActive ? 'block' : 'none';
    wrapYear.style.display  = monthActive ? 'none'  : 'block';
    if (statsMonth && statsYear) {
      statsMonth.style.display = monthActive ? 'block' : 'none';
      statsYear.style.display  = monthActive ? 'none'  : 'block';
    }
    if (filterMonth && filterYear) {
      filterMonth.style.display = monthActive ? 'flex' : 'none';
      filterYear.style.display  = monthActive ? 'none'  : 'flex';
    }
    if (tabInput) tabInput.value = tab;
    if (modeMonth && modeYear) {
      modeMonth.classList.toggle('active', monthActive);
      modeYear.classList.toggle('active', !monthActive);
    }
  }

  function syncMonthLabel(labelText){
    if (!monthLabel) return;
    if (labelText) {
      monthLabel.textContent = `(${labelText})`;
      return;
    }
    const opt = selMonth?.selectedOptions?.[0];
    if (opt) monthLabel.textContent = `(${opt.textContent})`;
  }

  function setValueWithUnit(el, value, unit){
    if (!el) return;
    el.innerHTML = `${value} <span class="metric-unit">${unit}</span>`;
  }
  function setValue(el, value){
    if (!el) return;
    el.textContent = value;
  }
  function fmtDuration(sec){
    sec = Number(sec||0);
    if (sec < 60) return `${sec}s`;
    let m = Math.floor(sec/60);
    const s = Math.floor(sec%60);
    if (m < 60) return s ? `${m} min ${s} s` : `${m} min`;
    const h = Math.floor(m/60);
    m = m % 60;
    return m === 0 ? `${h}h` : `${h}h ${m}min`;
  }
  function fmtPace(avgSpd){
    const spd = Number(avgSpd||0);
    if (spd <= 0) return '-';
    let p = 1000 / spd;
    let min = Math.floor(p/60);
    let sec = Math.round(p % 60);
    if (sec === 60) { min += 1; sec = 0; }
    return `${min}:${sec.toString().padStart(2,'0')} /km`;
  }
  function updateMonthStats(summary, labelText){
    if (!summary) return;
    syncMonthLabel(labelText);
    const distKm = ((summary.DistM ?? summary.distM ?? 0)/1000).toFixed(2);
    setValueWithUnit(monthDist, distKm, 'km');
    setValue(monthDur, fmtDuration(summary.DurS ?? summary.durS ?? 0));
    setValue(monthPace, fmtPace(summary.AvgSpd ?? summary.avgSpd ?? 0));
    setValueWithUnit(monthElev, Math.round(summary.ElevM ?? summary.elevM ?? 0), 'm');
    setValue(monthCount, summary.Count ?? summary.count ?? 0);
  }
  function updateYearStats(summary, labelText){
    if (!summary) return;
    if (yearLabel && labelText) yearLabel.textContent = `(${labelText})`;
    const distKm = ((summary.DistM ?? summary.distM ?? 0)/1000).toFixed(2);
    setValueWithUnit(yearDist, distKm, 'km');
    setValue(yearDur, fmtDuration(summary.DurS ?? summary.durS ?? 0));
    setValue(yearPace, fmtPace(summary.AvgSpd ?? summary.avgSpd ?? 0));
    setValueWithUnit(yearElev, Math.round(summary.ElevM ?? summary.elevM ?? 0), 'm');
    setValue(yearCount, summary.Count ?? summary.count ?? 0);
  }

  function showEmpty(canvasId, msg = 'No data for selection') {
    const ctx = document.getElementById(canvasId).getContext('2d');
    const {width, height} = ctx.canvas;
    ctx.clearRect(0,0,width,height);
    ctx.font = '14px system-ui'; ctx.fillStyle = '#6b7280';
    ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
    ctx.fillText(msg, width/2, height/2);
  }

  // Sport colors - consistent mapping
  // Harmonize sport colors with HR zone palette
  const sportColors = {
    'running': 'rgba(16, 185, 129, 0.85)',   // hr-zone-3-ish green
    'cycling': 'rgba(59, 130, 246, 0.85)',   // hr-zone-2 blue
    'walking': 'rgba(148, 163, 184, 0.85)',  // hr-zone-1 gray
    'hiking': 'rgba(251, 191, 36, 0.85)',    // hr-zone-4 yellow
    'swimming': 'rgba(6, 182, 212, 0.85)',   // teal
    'other': 'rgba(107, 114, 128, 0.85)',    // muted gray
    'generic': 'rgba(236, 72, 153, 0.85)'    // accent pink
  };

  function getSportColor(sport) {
    const sportLower = (sport || '').toLowerCase();
    if (sportColors[sportLower]) return sportColors[sportLower];
    if (sportLower.includes('run')) return sportColors.running;
    if (sportLower.includes('cycl') || sportLower.includes('bik')) return sportColors.cycling;
    if (sportLower.includes('walk')) return sportColors.walking;
    if (sportLower.includes('hik')) return sportColors.hiking;
    if (sportLower.includes('swim')) return sportColors.swimming;
    return sportColors.generic;
  }

  function renderBar(canvasId, data, title){
    const ctx = document.getElementById(canvasId).getContext('2d');
    const prev = canvasId === 'chartMonthCanvas' ? chartMonth : chartYear;
    if (prev) prev.destroy();

    if (!data.labels || data.labels.length === 0) {
      showEmpty(canvasId);
      if (canvasId==='chartMonthCanvas') chartMonth=null; else chartYear=null;
      return;
    }

    let datasets = [];

    if (data.hasSports && data.sports) {
      // Multi-sport stacked bar chart
      const sportsKeys = Object.keys(data.sports).sort();
      datasets = sportsKeys.map(sport => ({
        label: sport,
        data: data.sports[sport] || [],
        borderWidth: 0,
        backgroundColor: getSportColor(sport)
      }));
    } else {
      // Single dataset (filtered by sport or old format)
      const vals = (data.kms || []).map(v => +v || 0);
      const color = currentSport ? getSportColor(currentSport) : 'rgba(37, 99, 235, 0.85)';
      datasets = [{
        label: title,
        data: vals,
        borderWidth: 0,
        backgroundColor: color
      }];
    }

    const chart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: data.labels,
        datasets: datasets
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: false,
        plugins: {
          legend: {
            display: true,
            position: 'top'
          },
          tooltip: {
            callbacks: {
              label: c => `${c.dataset.label}: ${(c.parsed.y??0).toFixed(1)} km`
            }
          }
        },
        scales: {
          x: {
            stacked: data.hasSports,
            ticks: { autoSkip: true, maxRotation: 0 },
            grid: { display:false }
          },
          y: {
            stacked: data.hasSports,
            beginAtZero: true,
            title: { display: true, text: 'km' },
            ticks: { precision: 0 }
          }
        }
      }
    });
    if (canvasId === 'chartMonthCanvas') chartMonth = chart; else chartYear = chart;
  }

  const fetchJSON = async (url) => {
    const res = await fetch(url, { cache: 'no-store' });
    if (!res.ok) throw new Error(url + ' -> ' + res.status);
    return res.json();
  };

  async function populatePeriods(){
    const p = await fetchJSON('/api/stats/periods?_t=' + Date.now());
    selMonth.innerHTML = '';
    for (const m of (p.months || [])) {
      const opt = document.createElement('option');
      opt.value = m.ym; opt.textContent = m.label; selMonth.appendChild(opt);
    }
    selYear.innerHTML = '';
    for (const y of (p.years || [])) {
      const opt = document.createElement('option');
      opt.value = y; opt.textContent = y; selYear.appendChild(opt);
    }
    if (startMonth && selMonth.querySelector(`option[value="${startMonth}"]`)) {
      selMonth.value = startMonth;
    } else if (p.months?.length) {
      selMonth.value = p.months[0].ym;
    }
    if (startYear && selYear.querySelector(`option[value="${startYear}"]`)) {
      selYear.value = startYear;
    } else if (p.years?.length) {
      selYear.value = p.years[0];
    }
    if (hiddenMonth && selMonth.value) hiddenMonth.value = selMonth.value;
    if (hiddenYear && selYear.value) hiddenYear.value = selYear.value;
    syncMonthLabel();
  }

  async function loadMonth(){
    const ym = selMonth.value;
    if (!ym) { showEmpty('chartMonthCanvas'); return; }
    if (hiddenMonth) hiddenMonth.value = ym;
    const [year, month] = ym.split('-');
    const params = { gran:'month', year, month, _t: Date.now().toString() };
    if (currentSport) params.sport = currentSport;
    const qs = new URLSearchParams(params).toString();
    const data = await fetchJSON('/api/stats?' + qs);
    const label = currentSport ? currentSport : 'Daily mileage';
    renderBar('chartMonthCanvas', data, label);
    updateMonthStats(data.summary, data.label);
  }

  async function loadYear(){
    const year = selYear.value;
    if (!year) { showEmpty('chartYearCanvas'); return; }
    if (hiddenYear) hiddenYear.value = year;
    const params = { gran:'year', year, _t: Date.now().toString() };
    if (currentSport) params.sport = currentSport;
    const qs = new URLSearchParams(params).toString();
    const data = await fetchJSON('/api/stats?' + qs);
    const label = currentSport ? currentSport : 'Monthly mileage';
    renderBar('chartYearCanvas', data, label);
    updateYearStats(data.summary, data.label || year);
  }

  // Events
  selMonth.addEventListener('change', () => { syncMonthLabel(); loadMonth(); });
  selYear .addEventListener('change', loadYear);
  if (modeMonth) modeMonth.addEventListener('click', () => { if (tabInput) tabInput.value = 'month'; activate('month'); filterForm?.requestSubmit(); });
  if (modeYear) modeYear.addEventListener('click', () => { if (tabInput) tabInput.value = 'year'; activate('year'); filterForm?.requestSubmit(); });

  // Init
  (async function init(){
    const initialTab = (tabInput && tabInput.value === 'year') ? 'year' : 'month';
    activate(initialTab);
    await populatePeriods();
    if (selMonth.value) await loadMonth();
    if (selYear.value)  await loadYear();
    if (initialTab === 'year') {
      activate('year');
    } else {
      syncMonthLabel();
    }
  })();
});
</script>
{{end}}
